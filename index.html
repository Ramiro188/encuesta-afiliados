<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tu Voz Tu Salud Perú - Gracias por Participar</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --color-primario: #007BFF;
            --color-secundario: #00C6A7;
            --color-fondo: #f8f9fa;
            --color-tarjeta: #ffffff;
            --color-texto-principal: #212529;
            --color-texto-secundario: #495057;
            --color-borde: #dee2e6;
            --sombra-tarjeta: 0 5px 25px rgba(0, 0, 0, 0.07);
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--color-fondo);
            background-image: linear-gradient(180deg, #fdfdff 0%, #f8f9fa 100%);
            color: var(--color-texto-principal);
            margin: 0;
            line-height: 1.7;
        }
        .container { max-width: 700px; margin: 0 auto; padding: 20px; }
        .animated-card { opacity: 0; transform: translateY(30px); transition: opacity 0.6s ease-out, transform 0.6s ease-out; }
        .animated-card.is-visible { opacity: 1; transform: translateY(0); }
        .header { text-align: center; padding: 50px 20px 30px; }
        .header .logo {
            font-size: 2.8rem;
            font-weight: 700;
            background: linear-gradient(45deg, var(--color-primario), var(--color-secundario));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .card {
            background-color: var(--color-tarjeta);
            border-radius: 16px;
            padding: 35px;
            margin-bottom: 30px;
            box-shadow: var(--sombra-tarjeta);
            border: 1px solid var(--color-borde);
        }
        h2 {
            font-size: 1.8rem; text-align: center; margin-top: 0; margin-bottom: 30px; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        h2 .icon { color: var(--color-primario); }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 1rem; }
        .form-group input {
            width: 100%; padding: 15px; border: 1px solid var(--color-borde); border-radius: 10px; font-size: 1.1rem; font-family: 'Poppins', sans-serif; box-sizing: border-box; transition: border-color 0.3s, box-shadow 0.3s;
        }
        .form-group input:read-only { background-color: #f1f3f5; cursor: not-allowed; }
        .btn-submit {
            width: 100%; padding: 16px; background-color: var(--color-primario); color: white; border: none; border-radius: 10px; font-size: 1.2rem; font-weight: 600; cursor: pointer; transition: background-color 0.3s, transform 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-submit:hover { background-color: #0056b3; transform: translateY(-2px); }
        .btn-submit:disabled { background-color: #6c757d; cursor: not-allowed; }
        .spinner { width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .dashboard { text-align: center; }
        .dashboard-intro { font-size: 1.1rem; margin-bottom: 25px; }
        .referral-link-container {
            background-color: #e7f3ff; padding: 15px; border-radius: 10px; border: 1px dashed var(--color-primario); margin: 25px 0; word-wrap: break-word; font-weight: 600; color: var(--color-primario);
        }
        .dashboard-actions { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
        .btn-action {
            padding: 15px 25px; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; border: none; flex-grow: 1;
        }
        #copy-btn { background-color: var(--color-secundario); color: white; }
        #whatsapp-btn { background-color: #25D366; color: white; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .ranking-list { list-style: none; padding: 0; }
        .ranking-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid var(--color-borde); }
        .ranking-item:last-child { border-bottom: none; }
        .rank-position { font-size: 1.5rem; font-weight: 700; color: var(--color-primario); margin-right: 20px; width: 40px; text-align: center; }
        .rank-name { font-weight: 600; flex-grow: 1; }
        .rank-count { font-weight: 600; color: var(--color-secundario); }
        .current-user-rank { margin-top: 25px; padding: 20px; background-color: #e7f3ff; border-radius: 10px; border-left: 5px solid var(--color-primario); font-weight: 600; text-align: center; }
        #timer { display: flex; justify-content: space-around; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .timer-box { background-color: var(--color-tarjeta); padding: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); min-width: 80px; text-align: center; }
        .timer-value { font-size: 2.5rem; font-weight: 700; color: var(--color-primario); }
        .timer-label { font-size: 0.9rem; color: var(--color-texto-secundario); margin-top: 5px; }
        .footer { text-align: center; padding: 30px 20px; color: var(--color-texto-secundario); font-size: 0.9rem; margin-top: 20px; }
        .footer a { color: var(--color-primario); font-weight: 600; text-decoration: none; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <header class="header">
        <div class="logo">Tu Voz Tu Salud</div>
    </header>

    <div class="container">

        <!-- Módulo de Registro (ahora es el paso 2) -->
        <div id="registro-card" class="card animated-card">
            <h2><i class="icon fa-solid fa-award"></i>¡Gracias por alzar tu voz!</h2>
            <p style="text-align: center; margin-top: -20px; margin-bottom: 30px;">Tu encuesta ha sido registrada. Como siguiente paso, te invitamos a convertirte en afiliador/a para ayudarnos a sumar más voces y participar por premios.</p>
            
            <form id="referralForm">
                <div class="form-group">
                    <label for="userName">Tu Nombre (Confirmar)</label>
                    <input type="text" id="userName" name="userName" required readonly>
                </div>
                <div class="form-group">
                    <label for="userEmail">Tu Correo (Confirmar)</label>
                    <input type="email" id="userEmail" name="userEmail" required readonly>
                </div>
                <div class="form-group">
                    <label for="userYape">Tu Número de Celular o Yape (Para los premios)</label>
                    <input type="tel" id="userYape" name="userYape" placeholder="Ingresa tu número aquí" required>
                </div>
                <input type="hidden" id="referrerId" name="referrerId">
                
                <button type="submit" id="submit-btn" class="btn-submit">
                    <span id="btn-text">Activar mi panel y participar</span>
                    <div id="spinner" class="spinner hidden"></div>
                </button>
                <div id="form-message" style="margin-top: 15px; text-align: center; color: red;"></div>
            </form>
        </div>

        <!-- Dashboard de Afiliados (Oculto inicialmente) -->
        <div id="dashboard-card" class="card animated-card hidden">
            <h2><i class="icon fa-solid fa-rocket"></i>¡Listo! Tu panel de impacto está activo</h2>
            <p class="dashboard-intro">Hola <strong id="dashboard-username"></strong>, ahora eres un/a agente de cambio. Comparte tu enlace personal para que más personas respondan la encuesta. ¡Mientras más invites, más chances tienes de ganar!</p>
            
            <p style="font-weight: 600; margin-bottom: 10px;">Tu enlace personal para compartir:</p>
            <div id="user-referral-link" class="referral-link-container"></div>
            
            <div class="dashboard-actions">
                <button id="copy-btn" class="btn-action"><i class="fa-solid fa-copy"></i> Copiar Enlace</button>
                <button id="whatsapp-btn" class="btn-action"><i class="fa-brands fa-whatsapp"></i> Compartir por WhatsApp</button>
            </div>
        </div>

        <!-- Ranking y Temporizador (siguen siendo relevantes) -->
        <div id="ranking-card" class="card animated-card">
            <h2><i class="icon fa-solid fa-ranking-star"></i>Ranking de Impacto</h2>
            <ol id="ranking-list" class="ranking-list"></ol>
            <div id="current-user-rank" class="current-user-rank hidden"></div>
        </div>
        
        <div id="countdown-card" class="card animated-card">
            <h2><i class="icon fa-solid fa-clock"></i>Cierre de la campaña y sorteo</h2>
            <div id="timer"></div>
        </div>
    </div>

    <footer class="footer">
        Un proyecto de <a href="https://clinic-ios.com" target="_blank">Clinic IOS</a> para la campaña nacional <br><strong>Tu Voz Tu Salud Perú</strong>
    </footer>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- SELECTORES ---
        const referralForm = document.getElementById('referralForm');
        const registroCard = document.getElementById('registro-card');
        const dashboardCard = document.getElementById('dashboard-card');
        const userNameInput = document.getElementById('userName');
        const userEmailInput = document.getElementById('userEmail');
        const referrerIdInput = document.getElementById('referrerId');
        const submitBtn = document.getElementById('submit-btn');
        const btnText = document.getElementById('btn-text');
        const spinner = document.getElementById('spinner');

        // --- LÓGICA DE ANIMACIÓN ---
        const animatedCards = document.querySelectorAll('.animated-card');
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('is-visible');
                    observer.unobserve(entry.target);
                }
            });
        }, { threshold: 0.1 });
        animatedCards.forEach(card => observer.observe(card));

        // --- ⚙️ LÓGICA PRINCIPAL DEL NUEVO FLUJO ---
        
        // 1. Leer datos de la URL (enviados por Tally)
        const urlParams = new URLSearchParams(window.location.search);
        const nombreFromUrl = urlParams.get('nombre');
        const emailFromUrl = urlParams.get('email');
        const refIdFromUrl = urlParams.get('ref'); // ID de quien refirió a esta persona A LA ENCUESTA

        // 2. Pre-llenar el formulario
        if (nombreFromUrl) {
            userNameInput.value = nombreFromUrl;
        }
        if (emailFromUrl) {
            userEmailInput.value = emailFromUrl;
        }
        if (refIdFromUrl) {
            referrerIdInput.value = refIdFromUrl;
        }

        // 3. Revisar si el usuario ya activó su panel antes (vía localStorage)
        const savedUser = localStorage.getItem('tvtsUser');
        if (savedUser) {
            showDashboard(JSON.parse(savedUser));
        }

        // 4. Manejar el envío del formulario de activación
        referralForm.addEventListener('submit', function(event) {
            event.preventDefault();
            
            submitBtn.disabled = true;
            btnText.textContent = 'Activando...';
            spinner.classList.remove('hidden');

            const formData = new FormData(referralForm);
            
            // Generar el ID único para ESTE NUEVO AFILIADO
            const uniqueId = formData.get('userName').split(' ')[0].substring(0, 4).toUpperCase() + Math.random().toString(36).substring(2, 6).toUpperCase();
            formData.append('userId', uniqueId); // Este será su ID de referido

            const data = Object.fromEntries(formData.entries());

            console.log("Datos del nuevo afiliado a enviar:", data);
            
            // --- 🔽 CONEXIÓN CON GOOGLE APPS SCRIPT 🔽 ---
            // Aquí enviarías los datos a tu Google Sheet de *Afiliados*.
            setTimeout(() => { // Simulación de envío
                showDashboard(data);
                localStorage.setItem('tvtsUser', JSON.stringify(data));
            }, 1500);
        });

        function showDashboard(userData) {
            registroCard.classList.add('hidden');
            dashboardCard.classList.remove('hidden');
            document.getElementById('current-user-rank').classList.remove('hidden');

            // **IMPORTANTE**: El enlace de referido para este usuario ahora apunta a Tally
            // ¡DEBES CAMBIAR ESTA URL POR LA DE TU ENCUESTA!
            const baseSurveyUrl = "https://tally.so/r/tu-encuesta-id"; 
            const referralLink = `${baseSurveyUrl}?ref=${userData.userId}`;

            document.getElementById('dashboard-username').textContent = userData.userName.split(' ')[0];
            document.getElementById('user-referral-link').textContent = referralLink;

            document.getElementById('copy-btn').addEventListener('click', () => {
                navigator.clipboard.writeText(referralLink).then(() => {
                    const btn = document.getElementById('copy-btn');
                    btn.innerHTML = '<i class="fa-solid fa-check"></i> ¡Copiado!';
                    setTimeout(() => { btn.innerHTML = '<i class="fa-solid fa-copy"></i> Copiar Enlace'; }, 2000);
                });
            });

            document.getElementById('whatsapp-btn').addEventListener('click', () => {
                const message = encodeURIComponent(`¡Hola! Acabo de participar en "Tu Voz Tu Salud Perú", una campaña para mejorar la salud en el país. ¡Suma tu voz tú también! Responde esta corta encuesta: ${referralLink}`);
                window.open(`https://api.whatsapp.com/send?text=${message}`, '_blank');
            });

            document.getElementById('current-user-rank').innerHTML = `¡Genial! Ya estás en el ranking. Por ahora tienes <strong>0 referidos</strong>. ¡Empieza a compartir!`;
        }

        // --- CÓDIGO DE RANKING Y TEMPORIZADOR (sin cambios) ---
        const rankingList = document.getElementById('ranking-list');
        const topReferrers = [
            { name: 'Juan C.', count: 87 }, { name: 'Sofia V.', count: 72 }, { name: 'Carlos P.', count: 55 },
            { name: 'Ana G.', count: 48 }, { name: 'Luis M.', count: 41 },
        ];
        rankingList.innerHTML = topReferrers.map((user, index) => `
            <li class="ranking-item">
                <span class="rank-position">#${index + 1}</span><span class="rank-name">${user.name}</span><span class="rank-count">${user.count} referidos</span>
            </li>`).join('');

        const countdownDate = new Date("July 28, 2024 23:59:59").getTime();
        const timerContainer = document.getElementById('timer');
        setInterval(() => {
            const distance = countdownDate - new Date().getTime();
            if (distance < 0) {
                timerContainer.innerHTML = "<h3 style='color:var(--color-secundario);'>¡Campaña finalizada!</h3>"; return;
            }
            const d = Math.floor(distance/(1000*60*60*24)), h = Math.floor((distance%(1000*60*60*24))/(1000*60*60)), m = Math.floor((distance%(1000*60*60))/(1000*60)), s = Math.floor((distance%(1000*60))/1000);
            timerContainer.innerHTML = `<div class="timer-box"><span class="timer-value">${String(d).padStart(2,'0')}</span><span class="timer-label">Días</span></div><div class="timer-box"><span class="timer-value">${String(h).padStart(2,'0')}</span><span class="timer-label">Horas</span></div><div class="timer-box"><span class="timer-value">${String(m).padStart(2,'0')}</span><span class="timer-label">Minutos</span></div><div class="timer-box"><span class="timer-value">${String(s).padStart(2,'0')}</span><span class="timer-label">Segundos</span></div>`;
        }, 1000);
    });
    </script>
</body>
</html>
