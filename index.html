<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Campa√±a de Referidos - Gana S/100</title>
    <!-- TODO: Incluye aqu√≠ el estilo (CSS) que ya tienes -->
    <!-- Lo omitimos aqu√≠ para que el c√≥digo sea m√°s manejable -->
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üéØ CAMPA√ëA DE REFERIDOS</h1>
            <p class="subtitle">¬°Participa y gana S/100! Comparte tu enlace y multiplica tus oportunidades</p>
        </header>

        <!-- Temporizador -->
        <div class="timer-container">
            <h3 class="timer-title">‚è∞ Tiempo restante de la campa√±a</h3>
            <div class="timer" id="countdown">
                <!-- Contenido de unidades de tiempo -->
            </div>
        </div>

        <!-- Formulario de registro -->
        <div class="form-section" id="registration-form">
            <h2>üìù Reg√≠strate para participar</h2>
            <form id="userForm">
                <div class="form-group">
                    <label for="nombre">üë§ Nombre completo *</label>
                    <input type="text" id="nombre" name="nombre" required>
                </div>
                <div class="form-group">
                    <label for="correo">üìß Correo electr√≥nico *</label>
                    <input type="email" id="correo" name="correo" required>
                </div>
                <div class="form-group">
                    <label for="yape">üí≥ N√∫mero de Yape *</label>
                    <input type="tel" id="yape" name="yape" required placeholder="Ej: 987654321">
                </div>
                <button type="submit" class="submit-btn" id="submitBtn">
                    üöÄ Registrarme y obtener mi enlace
                </button>
            </form>
            <div id="alerts"></div>
        </div>

        <!-- Secci√≥n de √©xito -->
        <div class="success-section" id="success-section">
            <h2 class="success-title">üéâ ¬°Est√°s participando por S/100!</h2>
            <p>Comparte tu enlace para ganar m√°s oportunidades:</p>
            <div class="affiliate-link" id="affiliate-link"></div>
            <button class="copy-btn" onclick="copyLink()">üìã Copiar enlace</button>
            <button class="copy-btn" onclick="shareWhatsApp()">üì± Compartir en WhatsApp</button>
        </div>

        <!-- Ranking -->
        <div class="ranking-section">
            <h2>üèÜ Ranking de Afiliados</h2>
            <table class="ranking-table">
                <thead>
                    <tr>
                        <th>Posici√≥n</th>
                        <th>Nombre</th>
                        <th>Referidos</th>
                    </tr>
                </thead>
                <tbody id="ranking-body">
                    <tr>
                        <td colspan="3" class="loading">Cargando ranking...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyjLwL9IoRgdlXXfgf7aWHhBeCDRqeooxGMgdubmYRd5zW0F4FIL9iCHXTQGYuHRuR3/exec';
        const CAMPAIGN_END = new Date('2025-07-06T20:00:00-05:00');
        const BASE_URL = window.location.origin + window.location.pathname;

        let userAffiliateId = null;
        let referredBy = null;

        document.addEventListener('DOMContentLoaded', function() {
            checkReferralCode();
            startCountdown();
            loadRanking();
            checkExistingUser();
        });

        function checkReferralCode() {
            const urlParams = new URLSearchParams(window.location.search);
            const ref = urlParams.get('ref');
            if (ref) referredBy = ref;
        }

        function checkExistingUser() {
            const savedUser = localStorage.getItem('userAffiliateId');
            if (savedUser) {
                userAffiliateId = savedUser;
                showSuccessSection(BASE_URL + '?ref=' + userAffiliateId);
            }
        }

        function startCountdown() {
            function updateTimer() {
                const now = new Date().getTime();
                const distance = CAMPAIGN_END.getTime() - now;
                if (distance < 0) return;
                // Calcula y actualiza el DOM
            }
            updateTimer();
            setInterval(updateTimer, 1000);
        }

        document.getElementById('userForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            const alertsDiv = document.getElementById('alerts');
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ Registrando...';
            alertsDiv.innerHTML = '';

            try {
                const formData = {
                    nombre: document.getElementById('nombre').value.trim(),
                    correo: document.getElementById('correo').value.trim(),
                    yape: document.getElementById('yape').value.trim(),
                    referidoPor: referredBy || '',
                    timestamp: new Date().toISOString()
                };
                const userId = generateUserId(formData.nombre);
                formData.userId = userId;

                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                if (result.success) {
                    userAffiliateId = userId;
                    localStorage.setItem('userAffiliateId', userId);
                    const affiliateLink = BASE_URL + '?ref=' + userId;
                    showSuccessSection(affiliateLink);
                    loadRanking();
                    showAlert('Registro exitoso', 'success');
                } else {
                    throw new Error(result.message);
                }

            } catch (error) {
                console.error(error);
                showAlert('Error al registrar.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'üöÄ Registrarme y obtener mi enlace';
            }
        });

        function generateUserId(nombre) {
            const cleanName = nombre.toLowerCase().replace(/[^a-z0-9]/g, '');
            const timestamp = Date.now().toString().slice(-6);
            return cleanName.substring(0, 8) + timestamp;
        }

        function showSuccessSection(link) {
            document.getElementById('registration-form').style.display = 'none';
            document.getElementById('success-section').style.display = 'block';
            document.getElementById('affiliate-link').textContent = link;
        }

        function copyLink() {
            const link = document.getElementById('affiliate-link').textContent;
            navigator.clipboard.writeText(link).then(() => {
                showAlert('Enlace copiado', 'success');
            });
        }

        function shareWhatsApp() {
            const link = document.getElementById('affiliate-link').textContent;
            const message = `üéØ ¬°Participa y gana S/100! Reg√≠strate con mi enlace: ${link}`;
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        async function loadRanking() {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL + '?action=getRanking');
                const data = await response.json();
                const tbody = document.getElementById('ranking-body');
                if (data.success && data.ranking.length > 0) {
                    tbody.innerHTML = data.ranking.map((user, index) => `
                        <tr>
                            <td class="position">#${index + 1}</td>
                            <td>${user.nombre}</td>
                            <td>${user.referidos}</td>
                        </tr>`).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="3">A√∫n no hay participantes en el ranking</td></tr>';
                }
            } catch (error) {
                console.error('Error cargando ranking:', error);
                document.getElementById('ranking-body').innerHTML = '<tr><td colspan="3">Error al cargar ranking</td></tr>';
            }
        }

        function showAlert(message, type) {
            const alertsDiv = document.getElementById('alerts');
            alertsDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alertsDiv.innerHTML = '', 5000);
        }

        setInterval(loadRanking, 30000);
    </script>
</body>
</html>

