const SCRIPT_URL = 'https://script.google.com/macros/d/YOUR_SCRIPT_ID/exec';
const TALLY_FORM_URL = 'https://tally.so/r/mR15Xj';
const GITHUB_PAGE_URL = window.location.origin + window.location.pathname;

// Funciones mejoradas para manejar URLs y referidos
function getURLParameter(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return decodeURIComponent(urlParams.get(param) || '');
}

function validateReferrer(ref) {
    if (!ref || ref.trim() === '' || ref.toLowerCase() === '@ref') {
        return 'Directo';
    }
    return ref.trim();
}

// Sistema robusto de carga de ranking con JSONP
function loadRanking() {
    const script = document.createElement('script');
    const callbackName = `jsonp_callback_${Date.now()}`;
    
    window[callbackName] = function(data) {
        delete window[callbackName];
        script.parentNode.removeChild(script);
        
        if (data.error) {
            console.error('Error en datos del ranking:', data.error);
            return;
        }
        
        updateRankingDisplay(data);
    };

    script.src = `${SCRIPT_URL}?callback=${callbackName}`;
    document.head.appendChild(script);
}

function updateRankingDisplay(rankingData) {
    const rankingList = document.getElementById('ranking-list');
    
    const medals = {
        0: 'ðŸ¥‡',
        1: 'ðŸ¥ˆ',
        2: 'ðŸ¥‰'
    };
    
    rankingList.innerHTML = rankingData
        .map((item, index) => `
            <div class="ranking-item">
                <div class="rank-pos">${medals[index] || `#${index + 1}`}</div>
                <div class="rank-alias">${item.alias}</div>
                <div class="rank-count">${item.count} referidos</div>
            </div>
        `)
        .join('');
}

// Manejo de registro con validaciÃ³n robusta
async function handleRegistration(alias, yape, referrer) {
    try {
        const response = await fetch(`${SCRIPT_URL}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `userAlias=${encodeURIComponent(alias)}&userYape=${encodeURIComponent(yape)}&referrerId=${encodeURIComponent(referrer)}`
        });
        
        const result = await response.json();
        
        if (result.error) {
            throw new Error(result.error);
        }
        
        return result.alias;
    } catch (error) {
        console.error('Error en registro:', error);
        throw error;
    }
}

// InicializaciÃ³n y configuraciÃ³n del sistema
document.addEventListener('DOMContentLoaded', () => {
    const referrer = validateReferrer(getURLParameter('ref'));
    const savedUser = localStorage.getItem('tvtsUser');

    if (savedUser) {
        showDashboard(JSON.parse(savedUser).userAlias);
    } else {
        contentContainer.innerHTML = registrationTemplate(referrer);
        initializeForm();
    }

    // Cargar ranking inicialmente y cada minuto
    loadRanking();
    setInterval(loadRanking, 60000);
});
