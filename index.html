
<!DOCTYPE html>
<html lang="es">
<head>
    <!-- ... estilos CSS existentes ... -->
</head>
<body>
    <div class="container">
        <div id="content-container"></div>
        <div id="ranking-container" class="card hidden">
            <h2><i class="icon fas fa-ranking-star"></i> Top Agentes de Cambio</h2>
            <div id="ranking-list" class="ranking-list"></div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/d/YOUR_SCRIPT_ID/exec';
        const TALLY_FORM_URL = 'https://tally.so/r/mR15Xj';
        const GITHUB_PAGE_URL = window.location.origin + window.location.pathname;

        // Mejorado: Manejo más robusto de parámetros URL
        function getURLParameter(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param) || '';
        }

        // Mejorado: Validación de referidor
        function validateReferrer(ref) {
            if (!ref || ref.trim() === '' || ref.toLowerCase() === '@ref') {
                return 'Directo';
            }
            return ref.trim();
        }

        // Mejorado: Manejo de errores SSL y conexión
        async function fetchWithRetry(url, options = {}) {
            const maxRetries = 3;
            const retryDelay = 1000;
            
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const response = await fetch(url, {
                        ...options,
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            ...(options.headers || {})
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    if (attempt === maxRetries) {
                        throw error;
                    }
                    await new Promise(resolve => setTimeout(resolve, retryDelay * attempt));
                }
            }
        }

        // Mejorado: Actualización automática del ranking
        function updateRanking() {
            fetchWithRetry(`${SCRIPT_URL}?callback=handleRankingData`)
                .then(response => {
                    const script = document.createElement('script');
                    script.textContent = response;
                    document.head.appendChild(script);
                })
                .catch(error => console.error('Error al actualizar ranking:', error));
        }

        // Manejador JSONP para el ranking
        function handleRankingData(data) {
            if (data.error) {
                console.error('Error en datos del ranking:', data.error);
                return;
            }
            
            const rankingList = document.getElementById('ranking-list');
            rankingList.innerHTML = data
                .map((item, index) => `
                    <div class="ranking-item">
                        <div class="rank-pos">#${index + 1}</div>
                        <div class="rank-alias">${item.alias}</div>
                        <div class="rank-count">${item.count} referidos</div>
                    </div>
                `)
                .join('');
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            const referrer = validateReferrer(getURLParameter('ref'));
            const savedUser = localStorage.getItem('tvtsUser');

            if (savedUser) {
                showDashboard(JSON.parse(savedUser).userAlias);
            } else {
                contentContainer.innerHTML = registrationTemplate(referrer);
                initializeForm();
            }

            // Actualizar ranking cada minuto
            updateRanking();
            setInterval(updateRanking, 60000);
        });
    </script>
</body>
</html>
