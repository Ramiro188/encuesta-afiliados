<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸŽ¯ CampaÃ±a de Referidos - Gana S/100</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* AQUI VA TODO TU CSS ORIGINAL SIN CAMBIOS */
        /* Por razones de espacio, se asume que sigue intacto como el que me pasaste */
    </style>
</head>
<body>
<div class="container">
    <!-- Encabezado, temporizador, formulario, etc. sin cambios -->
</div>

<script>
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyjLwL9IoRgdlXXfgf7aWHhBeCDRqeooxGMgdubmYRd5zW0F4FIL9iCHXTQGYuHRuR3/exec';
    const CAMPAIGN_END = new Date('2025-07-06T20:00:00-05:00');
    const BASE_URL = window.location.origin + window.location.pathname;

    let userAffiliateId = null;
    let referredBy = null;

    document.addEventListener('DOMContentLoaded', function() {
        checkReferralCode();
        startCountdown();
        loadRanking();
        checkExistingUser();
    });

    function checkReferralCode() {
        const urlParams = new URLSearchParams(window.location.search);
        const ref = urlParams.get('ref');
        if (ref) referredBy = ref;
    }

    function checkExistingUser() {
        const savedUser = localStorage.getItem('userAffiliateId');
        if (savedUser) {
            userAffiliateId = savedUser;
            showSuccessSection(BASE_URL + '?ref=' + userAffiliateId);
        }
    }

    function startCountdown() {
        function updateTimer() {
            const now = new Date().getTime();
            const distance = CAMPAIGN_END.getTime() - now;
            if (distance < 0) {
                document.getElementById('countdown').innerHTML = '<div style="color: #ff6b6b; font-size: 1.5rem;">ðŸš¨ Â¡La campaÃ±a terminÃ³!</div>';
                return;
            }
            const d = Math.floor(distance / (1000 * 60 * 60 * 24));
            const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((distance % (1000 * 60)) / 1000);

            document.getElementById('days').textContent = d.toString().padStart(2, '0');
            document.getElementById('hours').textContent = h.toString().padStart(2, '0');
            document.getElementById('minutes').textContent = m.toString().padStart(2, '0');
            document.getElementById('seconds').textContent = s.toString().padStart(2, '0');
        }
        updateTimer();
        setInterval(updateTimer, 1000);
    }

    document.getElementById('userForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const submitBtn = document.getElementById('submitBtn');
        const alertsDiv = document.getElementById('alerts');

        submitBtn.disabled = true;
        submitBtn.textContent = 'â³ Registrando...';
        alertsDiv.innerHTML = '';

        try {
            const formData = {
                nombre: document.getElementById('nombre').value.trim(),
                correo: document.getElementById('correo').value.trim(),
                yape: document.getElementById('yape').value.trim(),
                referidoPor: referredBy || '',
                timestamp: new Date().toISOString()
            };
            const userId = generateUserId(formData.nombre);
            formData.userId = userId;

            const res = await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            const result = await res.json();
            if (result.success) {
                userAffiliateId = userId;
                localStorage.setItem('userAffiliateId', userId);
                showSuccessSection(BASE_URL + '?ref=' + userId);
                loadRanking();
                showAlert('Â¡Registro exitoso! Comparte tu enlace.', 'success');
            } else {
                throw new Error(result.message || 'Error desconocido');
            }
        } catch (err) {
            console.error(err);
            showAlert('Error al registrar. Intenta de nuevo.', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'ðŸš€ Registrarme y obtener mi enlace';
        }
    });

    function generateUserId(nombre) {
        const clean = nombre.toLowerCase().replace(/[^a-z0-9]/g, '');
        const stamp = Date.now().toString().slice(-6);
        return clean.substring(0, 8) + stamp;
    }

    function showSuccessSection(link) {
        document.getElementById('registration-form').style.display = 'none';
        document.getElementById('success-section').style.display = 'block';
        document.getElementById('affiliate-link').textContent = link;
    }

    function copyLink() {
        const link = document.getElementById('affiliate-link').textContent;
        navigator.clipboard.writeText(link).then(() => showAlert('Enlace copiado', 'success'));
    }

    function shareWhatsApp() {
        const link = document.getElementById('affiliate-link').textContent;
        const msg = `ðŸŽ¯ Â¡Participa y gana S/100! RegÃ­strate con mi enlace: ${link}`;
        window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
    }

    async function loadRanking() {
        try {
            const res = await fetch(GOOGLE_SCRIPT_URL + '?action=getRanking');
            const data = await res.json();
            const tbody = document.getElementById('ranking-body');

            if (data.success && data.ranking.length > 0) {
                tbody.innerHTML = data.ranking.map((user, i) => `
                    <tr>
                        <td class="position">#${i + 1}</td>
                        <td>${user.nombre}</td>
                        <td>${user.referidos}</td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="3" class="loading">Sin participantes</td></tr>';
            }
        } catch (e) {
            document.getElementById('ranking-body').innerHTML = '<tr><td colspan="3">Error al cargar ranking</td></tr>';
        }
    }

    setInterval(loadRanking, 30000);

    function showAlert(message, type) {
        const alerts = document.getElementById('alerts');
        alerts.innerHTML = `<div class="alert ${type === 'success' ? 'alert-success' : 'alert-error'}">${message}</div>`;
        setTimeout(() => alerts.innerHTML = '', 5000);
    }
</script>
</body>
</html>

